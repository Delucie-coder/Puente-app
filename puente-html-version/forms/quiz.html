<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Quiz</title>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;margin:18px;color:#072f2a}
    .card{max-width:820px;margin:0 auto;padding:18px;border-radius:10px;border:1px solid #e6eef3;background:#fff}
    h1{font-size:20px;margin-bottom:6px}
    fieldset{border:1px solid #eef2f6;padding:12px;margin-bottom:10px;border-radius:8px}
    legend{font-weight:700}
    label{display:block;margin:6px 0}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#0aa36a;color:#fff;border:none;cursor:pointer}
    .result{margin-top:14px;padding:12px;border-radius:8px}
    .pass{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
    .fail{background:#fff1f2;color:#7f1d1d;border:1px solid #fecaca}
    .muted{color:#6b7280}
    a.back{display:inline-block;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">Weekly Quiz</h1>
    <div id="meta" class="muted">Loading...</div>
    <form id="quizForm"></form>
    <div style="margin-top:12px">
      <button id="submitBtn" class="btn">Submit</button>
      <a id="backLink" class="back" href="../dashboard.html">Back to Dashboard</a>
    </div>
    <div id="result" style="display:none"></div>
  </div>
  <script src="quiz-data.js"></script>
  <script>
    // parse week from query string
    function qs(name){ const p = new URLSearchParams(location.search); return p.get(name); }
    const week = Number(qs('week') || 1);
    // Adjust the back link so users return to the dashboard role they came from
    (function(){
      try{
        const back = document.getElementById('backLink');
        let role = null;
        try{ role = sessionStorage.getItem('puente_role') || localStorage.getItem('puente_role') || null; }catch(e){}
        // If role not found, attempt to infer from document.referrer
        if (!role && document.referrer){
          const r = document.referrer;
          if (r.indexOf('dashboard-vendor') !== -1) role = 'vendor';
          else if (r.indexOf('dashboard-moto') !== -1 || r.indexOf('dashboard-motor') !== -1) role = 'moto';
        }
        let href = '../dashboard.html';
        let label = 'Back to Dashboard';
        if (role === 'vendor'){ href = '../dashboard-vendor.html'; label = 'Back to Vendor Dashboard'; }
        else if (role === 'moto'){ href = '../dashboard-moto.html'; label = 'Back to Motorcyclist Dashboard'; }
        if (back){ back.setAttribute('href', href); back.textContent = label; }
      }catch(e){ /* non-fatal */ }
    })();
    const data = window.QUIZ_DATA && window.QUIZ_DATA[week] ? window.QUIZ_DATA[week] : [];
    document.getElementById('title').textContent = 'Week ' + week + ' Quiz';
    document.getElementById('meta').textContent = data.length ? 'Short 5-question quiz to test vocabulary.' : 'No quiz available for this week.';

    const form = document.getElementById('quizForm');
    if (!data.length){ form.innerHTML = '<p class="muted">No questions provided.</p>'; document.getElementById('submitBtn').disabled = true; }

    data.forEach((it, idx)=>{
      const fs = document.createElement('fieldset');
      const legend = document.createElement('legend'); legend.textContent = (idx+1) + '. ' + it.q; fs.appendChild(legend);
      it.choices.forEach((c, ci)=>{
        const id = `q_${idx}_${ci}`;
        const lab = document.createElement('label');
        lab.innerHTML = `<input type="radio" name="q_${idx}" id="${id}" value="${ci}"> ${c}`;
        fs.appendChild(lab);
      });
      form.appendChild(fs);
    });

    async function submit(){
      if (!data.length) return;
      let correct = 0; const answers = [];
      for(let i=0;i<data.length;i++){
        const els = document.getElementsByName('q_'+i);
        let picked = null;
        for(const el of els){ if (el.checked){ picked = Number(el.value); break; } }
        answers.push(picked);
        if (picked !== null && picked === data[i].a) correct++;
      }
      const score = Math.round((correct / data.length) * 100);
      const pass = correct >= 4; // require 4+ correct
      const resDiv = document.getElementById('result'); resDiv.style.display = 'block'; resDiv.className = 'result ' + (pass? 'pass':'fail');
      resDiv.innerHTML = `<strong>Result: ${score}%</strong><div class="muted" style="margin-top:6px">${pass? 'Passed â€” module will be marked complete.' : 'You did not pass. Please try again.'}</div>`;

      // attempt to POST attempt to server (if available)
      try{
        const payload = { lessonId: 'market_english_greetings', week, answers, score, date: new Date().toISOString() };
        await fetch('../api/attempts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      }catch(e){ /* ignore */ }

      // if pass, POST progress
      if (pass){ try{ await fetch('../api/progress', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ lessonId: 'market_english_greetings', week, score }) }); }catch(e){} }

      // disable submit
      document.getElementById('submitBtn').disabled = true;
      // after showing result, automatically return to the appropriate dashboard after a short delay
      try{
        const back = document.getElementById('backLink');
        const href = back && back.getAttribute('href') ? back.getAttribute('href') : '../dashboard.html';
        setTimeout(()=>{ window.location.href = href; }, 1600);
      }catch(e){}
    }

    document.getElementById('submitBtn').addEventListener('click', (ev)=>{ ev.preventDefault(); submit(); });
  </script>
</body>
</html>
